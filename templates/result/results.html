{% extends "base.html" %}

{% block title %}Results{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="text-center">
    <h3>{{ race.data.description }} <br>{{ race.data.location }}</h3>
    <h2>ПРОТОКОЛ РЕЗУЛЬТАТОВ</h2>
</div>
<div id="results-tables"></div>
<div>
    <table class="empty-table">
        <tr>
            <td><b>Главный судья:</b></td>
            <td width="150px"></td>
            <td><b>{{ race.data.chief_referee }}</b></td>
        </tr>
        <tr>
            <td><b>Главный секретарь:</b></td>
            <td width="150px"></td>
            <td><b>{{ race.data.secretary }}</b></td>
        </tr>
    </table>
</div>
{% raw %}
<script>
    var race = {% endraw %}{{race|tojson}}{% raw %};
    racePreparation(race);

    function getResultsByGroup(group) {
        var isRelay = group.__type ? group.__type === 3 : race.data.race_type === 3;
        var results = [];
        var index = 0;
        for (var result of race.results) {
            if (result.person && result.person.group.id === group.id) {
                index++;
                results.push({
                    index: index,
                    name: result.person.surname + ' ' + result.person.name,
                    org: (result.person.organization && result.person.organization.name) || '',
                    qual: Qualification[result.person.qual],
                    bib: result.person.bib,
                    year: result.person.birth_date ? (new Date(result.person.birth_date)).getFullYear() : '',
                    penalty_time: toHHMMSS(result.penalty_time),
                    penalty_laps: result.penalty_laps,
                    result: result.result,
                    diff: result.diff,
                    place: result.place || '',
                })
            }
        }
        results.sort((a, b) => {
            if (a.place === '') {
                return 1
            }
            if (b.place === '') {
                return -1
            }
            if (isRelay && a.place === b.place) {
                return ~~(a.bib / 1000) - ~~(b.bib / 1000)
            }
            return a.place - b.place
        });
        if (isRelay) {
            index = 0;
            var prevBib = 0;
            var resultsList = results.slice();
            results = [];
            for (var r of resultsList) {
                r.index = '';
                if (r.bib % 1000 !== prevBib) {
                    index++;
                    results.push({index: index});
                    prevBib = r.bib % 1000
                }
                results.push(r)
            }
        }
        return results;
    }

    var fields = [
        {key: 'index', title: '#'},
        {key: 'name', title: 'Фамилия, имя'},
        {key: 'org', title: 'Коллектив'},
        {key: 'year', title: 'ГР'},
        {key: 'qual', title: 'Разряд'},
        {key: 'bib', title: 'Номер'},
        {key: 'penalty_time', title: 'Штраф'},
        {key: 'penalty_laps', title: 'Штраф'},
        {key: 'result', title: 'Результат'},
        {key: 'diff', title: 'Отставание'},
        {key: 'place', title: 'Место'},
    ];

    for (var group of race.groups) {
        var titleBlock = document.createElement('h2');
        titleBlock.id = group.name;
        titleBlock.appendChild(document.createTextNode(group.name));
        document.getElementById('results-tables').appendChild(titleBlock);

        document.getElementById('results-tables').appendChild(getGroupsBlockElement(race));

        document.getElementById('results-tables').appendChild(new TableGenerator(getResultsByGroup(group), fields).getTable({className: 'sportorg-table'}));
    }

    new SettingsGenerator([
        {title: 'Отображать штрафное время', value: true},
        {title: 'Отображать кол-во штрафных кругов', value: true},
        {title: 'Отображать отставание', value: true},
        {title: 'Отображать сплиты', value: false},
    ]).show();
</script>
<div class="no-print"></div>
{% endraw %}
{% endblock %}